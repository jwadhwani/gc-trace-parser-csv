{"version":3,"sources":["../src/trace-parser-csv.js"],"names":[],"mappings":"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","file":"trace-parser-csv.js","sourcesContent":["\"use strict\";\n\n/**\n * Parse and convert a captured -trace_gc file to csv\n * See more at https://phptouch.com/2016/06/07/does-my-nodejs-application-leak-memory-4/\n * Copyright(c) 2016 Jayesh Wadhwani\n * MIT Licensed\n */\nconst fs = require('fs'),\n    _u = require('underscore'),\n    stringify = require('csv-stringify');\n\n/**\n *\n * @param {string} fName - nme of log file to read\n * @param callback - err, res where res - csv data\n * @returns {*}\n */\nmodule.exports = (fName, callback) => {\n    const\n        //array of objects - { pid, isolateId, timeSinceInit, gcEventType, beforeTotalSizeObject,\n        // afterTotalSizeObject, beforeTotalAllocatedSize,  afterTotalAllocatedSize,\n        // gcTime, externalTime, markingInfo, gcReason, gcCollectorReason}\n        data = [],\n        extras = [], //lines that did not match added to the end of the file\n        //regexes for various parts of the trace\n        mainRe = /^(\\[[\\d:xa-f]+?\\])\\s+(\\d.+?ms)\\s+((\\(|\\[).+)\\.$/,\n        isolateRe = /^\\[([\\d]+):(0x[0-9a-f]+)\\]$/,\n        statsRe = /^(\\d+)\\sms:\\s(Scavenge|Mark-sweep)\\s([\\d\\.]+)\\s\\(([\\d\\.]+)\\)\\s->\\s([\\d\\.]+)\\s\\(([\\d\\.]+)\\)\\sMB,\\s([\\d\\.]+)\\s\\/\\s([\\d\\.]+)\\sms$/,\n        infoRe = /^(\\((.+)\\)\\s+)?(\\[(.+?)\\])(\\s+\\[(.+?)\\])?$/,\n        csvData = [], //array for use with stringify\n        header = ['PID', 'Isolate Id', 'Time from initialization', 'GC Event',\n            'Total size of objects before GC', 'Total size of objects after GC',\n            'Total memory allocated before GC', 'Total memory allocated after GC',\n            'Time in GC', 'Time in external callbacks', 'Marking info',\n            'Reason for GC trigger', 'Reason for GC'\n        ];\n\n    fs.readFile(fName, 'utf-8', (err, fileData) => {\n        if (err) {\n            return callback(new Error('File not found or read error: ' + err.message));\n        }\n\n        fileData = fileData.trim();\n\n\n        if (!fileData) {\n            return callback(new Error('File empty: ' + fName));\n        }\n\n        //split file into array of lines\n        let lines = fileData.split('\\n');\n\n        lines.forEach((line, index) => {\n\n            line = line.trim(); //cleanup\n\n            const mainSection = mainRe.exec(line);\n\n            //trace - [38469:0x102004600]  1145185 ms: Mark-sweep 146.2 (187.0) -> 69.9 (121.0) MB, 0.6 / 0 ms (+ 40.0 ms in 31 steps since start of marking, biggest step 20.3 ms) [Incremental marking task: finalize incremental marking] [GC in old space requested].'\n\n            //main section - isolate, gcStats and gcInfo\n            //isolate - [38469:0x102004600]\n            //gcStats - '1145185 ms: Mark-sweep 146.2 (187.0) -> 69.9 (121.0) MB, 0.6 / 0 ms'\n            //gcInfo -  '(+ 40.0 ms in 31 steps since start of marking, biggest step 20.3 ms) [Incremental marking task: finalize incremental marking] [GC in old space requested]',\n\n            if (mainSection && mainSection[1] && mainSection[2] && mainSection[3]) {\n\n                const isolate = isolateRe.exec(mainSection[1]),\n                    gcStats = statsRe.exec(mainSection[2]),\n                    gcInfo = infoRe.exec(mainSection[3]);\n\n                if (isolate && gcStats && gcInfo) {\n                    const o = {\n                        pid: isolate[1],\n                        isolateId: isolate[2],\n                        timeSinceInit: gcStats[1],\n                        gcEventType: gcStats[2],\n                        beforeTotalSizeObject: gcStats[3],\n                        afterTotalSizeObject: gcStats[5],\n                        beforeTotalAllocatedSize: gcStats[4],\n                        afterTotalAllocatedSize: gcStats[6],\n                        gcTime: gcStats[7],\n                        externalTime: gcStats[8],\n                        markingInfo: '',\n                        gcReason: '',\n                        gcCollectorReason: ''\n                    };\n\n                    //reason for event is mandatory\n                    o.gcReason = gcInfo[4];\n\n\n                    //marking info is optional\n                    if (gcInfo[2]) {\n                        o.markingInfo = gcInfo[2];\n                    }\n\n                    //collector reason is optional\n                    if (gcInfo[6] != undefined) {\n                        o.gcCollectorReason = gcInfo[6];\n                    }\n\n                    data.push(o);\n                } else {\n                    extras.push([index, line]);\n                }\n\n            } else {\n\n                extras.push([index, line]);\n            }\n        });\n\n\n        //create CSV data\n        //add in the header\n        csvData.push(header);\n\n        //and the rows\n        data.forEach((element) => {\n            csvData.push(_u.values(element));\n        });\n\n        //make space and header for non matched lines\n        if (extras.length > 0) {\n            extras.unshift(['Index', 'Non matched lines']);\n            extras.unshift(['', '']);\n            extras.unshift(['', '']);\n            extras.unshift(['', '']);\n        }\n\n        //any lines that did not match\n        extras.forEach((element) => {\n            csvData.push(element);\n        });\n\n        //create CSV file\n        stringify(csvData, (err1, output) => {\n            return callback(err1, output);\n        });\n        return null;\n    });\n};\n"]}